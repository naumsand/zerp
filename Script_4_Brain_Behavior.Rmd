---
title: "Correlational analysis"
output: 
  rmdformats::material:
    highlight: kate
    css: web_style.css
    thumbnails: false
    lightbox: true
    gallery: true
    cards: true
    self_contained: no
    number_sections: no
    code_folding: hide
    fig_caption: yes
---

<!-- Set up workspace -->

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# Set general settings for Markdown file 
  options(max.print="75")

  knitr::opts_chunk$set(echo=TRUE,
                 prompt=FALSE,
                 tidy=TRUE,
                 comment=NA,
                 message=FALSE,
                 warning=FALSE,
                 results = FALSE,
  	             fig.align="center")
  knitr::opts_knit$set(width=75)
# Swipe environment
  rm(list=ls())
  
# Set libraries
  library(afex)
  library(car)
  library(emmeans) 
  library(ggplot2)
  library(lme4)
  library(MASS)
  library(miceadds)
  library(pander)
  library(ppcor)
  library(sjmisc)
  library(sjPlot)
  library(tidyverse)
  
# Round to 2 digits   
  options(digits=2)
  
# Disable scientific notation in R
  options(scipen = 999)
    
# Set figure color palettes
  ZE_ERP_col = c("#32104c","#50848A","#707070") 
  
  
# Correlation function
# https://stackoverflow.com/questions/34326906/extracting-and-formatting-results-of-cor-test-on-multiple-pairs-of-columns 
  corrFunc <- function(var1, var2, data) {
    result = cor.test(data[,var1], data[,var2])
    data.frame(var1, var2, result[c("estimate","p.value","statistic")], 
               stringsAsFactors=FALSE) }

```

```{r load_data, include = FALSE}

# Load questionnaire data
  load.Rdata(filename="./data/qn_data.Rdata", "qn_data")
     
```

# Correlations {.tabset .tabset-pills}

We performed correlational analyses using Pearson's correlations (p-values corrected for multiple comparisons using FDR) across all participants to associate brain and behavior variables which yielded training-induced changes. 

We correlated post-training values of SEC measures which indicated training-induced changes (EMK EM_P, EMK ER_P, EMK ER_CH, SDQ PB_P, SDQ BP_P) with P3 amplitude difference scores, which were sensitive to training group differences (happy minus neutral; angry minus neutral). We found a moderate positive correlation between the P3 happy vs. neutral difference score and the EMK 3-6 empathy parent rating (r = 0.28, p = 0.03). However, this comparison and other correlations did not survive FDR-correction (all p > .25).

```{r corr_plot_EMK_EM_P3_hap_neu, results = 'asis',fig.width = 5, fig.height = 5}

ggplot(qn_data, aes(x=EMK_EM_P_T2, y=P3_amp_hap_neu))+
       geom_point(size = 3)+
       geom_smooth(method=lm)

```

<div align="center">

```{r corr_P3_z, results = 'asis'}

# http://faculty.cas.usf.edu/mbrannick/regression/Part3/Partials.html

# Define correlation pairs of interest 
  vars_P3_amp_hap_neu = data.frame(v1=names(qn_data)[c(which(colnames(qn_data)=="z_P3_amp_hap_neu"))], 
                    v2=names(qn_data)[c(which(colnames(qn_data)=="z_EMK_EM_P_T2"), which(colnames(qn_data)=="z_EMK_EK_P_T2"),
                            which(colnames(qn_data)=="z_EMK_EK_CH_T2"), which(colnames(qn_data)=="z_SDQ_PB_T2"), which(colnames(qn_data)=="z_SDQ_T2"))])
  
  vars_P3_amp_ang_neu = data.frame(v1=names(qn_data)[c(which(colnames(qn_data)=="z_P3_amp_ang_neu"))], 
                    v2=names(qn_data)[c(which(colnames(qn_data)=="z_EMK_EM_P_T2"), which(colnames(qn_data)=="z_EMK_EK_P_T2"),
                            which(colnames(qn_data)=="z_EMK_EK_CH_T2"), which(colnames(qn_data)=="z_SDQ_PB_T2"), which(colnames(qn_data)=="z_SDQ_T2"))])

# Combine all correlation pairs 
  vars_P3_behav = rbind(vars_P3_amp_hap_neu, vars_P3_amp_ang_neu)
  
# Correlate pairs of interest  
  corrs_P3_behav = do.call(rbind, mapply(corrFunc, vars_P3_behav[,1], vars_P3_behav[,2], MoreArgs=list(data=qn_data), SIMPLIFY=FALSE))
  
  corrs_P3_behav = subset(corrs_P3_behav , select = -c(var1))

# Print table
  pander(corrs_P3_behav)

```

</div>


Corrected p-values (FDR): 

```{r corr_p_values_corrected, results = "asis"}

# Print corrected p-values  
  print(p.adjust(corrs_P3_behav$p.value, method = "fdr"))
```


